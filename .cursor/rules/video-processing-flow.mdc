---
description: Documents the core business logic for video frame processing, synchronization and overlay composition
globs: src/vidkompy/core/*.py,src/vidkompy/video/*.py,src/vidkompy/models.py
alwaysApply: false
---


# video-processing-flow

## Frame Processing Pipeline (90)
- Frame fingerprinting using perceptual hash combination
  - pHash for frequency domain analysis 
  - AverageHash for brightness patterns
  - ColorMomentHash for color distribution
  - MarrHildrethHash for edge detection
- Weighted fingerprint fusion based on content type
- Masked region handling for letterboxed content

## Temporal Alignment Engine (95) 
- Dynamic Time Warping with video-specific constraints
- Foreground frame preservation with background warping
- Progressive multi-resolution refinement
- Drift correction through polynomial regression
- Bidirectional refinement with confidence scoring

## Spatial Positioning System (85)
- Template matching with normalized correlation
- Content-aware refinement for letterboxed videos
- Automatic scale factor determination
- Position confidence validation
- Border region handling

## Composition Orchestration (80)
- Frame sequence validation
- Audio stream selection policy
- Quality threshold enforcement
- Drift prevention mechanisms
- Content integrity verification

File Paths:
```
src/vidkompy/core/
  ├── frame_fingerprint.py
  ├── temporal_alignment.py 
  ├── spatial_alignment.py
  └── video_processor.py
```

$END$