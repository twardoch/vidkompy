---
description: Comprehensive guide for video ingestion, processing, alignment and output generation workflow
globs: 
alwaysApply: false
---


# video-processing-flow

## Core Processing Pipeline

### Video Ingestion
- Frame extraction and fingerprinting using multi-algorithm perceptual hashing
- Parallel processing of frame batches for fingerprint generation
- Adaptive keyframe sampling based on video characteristics
- Importance Score: 85

### Frame Analysis 
- Multi-stage fingerprint generation combining:
  - Frequency domain analysis (pHash)
  - Average color patterns
  - Color distribution moments
  - Edge detection via Marr-Hildreth 
- Border region masking for edge-based alignment
- Importance Score: 90

### Temporal Alignment
- DTW-based frame matching with Sakoe-Chiba band constraint
- Adaptive keyframe density calculation
- Monotonic frame mapping with interpolation
- Temporal locality enforcement
- Importance Score: 95

### Spatial Positioning
- Template matching using normalized cross-correlation
- Dynamic scale factor computation
- Edge-based positioning for border mode
- Automatic offset calculation
- Importance Score: 85

### Composition Engine
- Sequential frame compositing
- Foreground frame preservation
- Dynamic background frame warping
- Audio stream selection and sync
- Importance Score: 80

### Output Generation
- Progressive frame writing
- Quality-preserving encoding
- Audio-video synchronization
- Metadata retention
- Importance Score: 75

Key Files:
```
src/vidkompy/core/
  ├── alignment_engine.py     # Main processing orchestrator
  ├── dtw_aligner.py         # Temporal alignment 
  ├── frame_fingerprint.py   # Frame analysis
  ├── spatial_alignment.py   # Position calculation
  └── video_processor.py     # I/O and composition
```

$END$