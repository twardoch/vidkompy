---
description: Defines core business rules for video composition, foreground preservation, and quality thresholds in video overlaying operations
globs: src/vidkompy/core/video_processor.py,src/vidkompy/core/alignment_engine.py,src/vidkompy/models/composition.py
alwaysApply: false
---


# video-composition-rules

## Core Composition Rules (Importance: 95)
1. Foreground video prioritization:
   - Foreground video is preserved as the "better quality" source
   - Never re-time or modify foreground video frames
   - Foreground frames dictate the output FPS
   - Foreground audio track takes precedence when both sources have audio

2. Background video adaptations:
   - Background video can be dynamically stretched/modified
   - Frame dropping/interpolation allowed for background synchronization
   - Background spatial position adjusted to accommodate foreground overlay

## Audio Handling Rules (Importance: 85)
1. Audio source selection:
   - If both videos have audio: Use foreground audio
   - If only one has audio: Use available audio track
   - Audio tracks used for temporal alignment when --match_time audio specified

2. Audio synchronization:
   - Audio track alignment determines frame timing
   - Audio cross-correlation used to find optimal time offset
   - Audio fallback to frame-based methods if unusable

## Quality and Resolution Rules (Importance: 90)
1. Resolution constraints:
   - Foreground video never larger than background video
   - Background video must fully contain foreground overlay
   - Output resolution matches background video dimensions

2. Frame preservation:
   - No quality loss allowed in foreground frames
   - Background frames may be transformed to match foreground timing
   - Output uses highest FPS between sources

## Temporal Alignment Rules (Importance: 88)
1. Frame selection:
   - Find optimal start/end frame pairs
   - Trim output to best matching segment
   - Drop non-matching frames from start/end
   - Preserve foreground frame sequence integrity

2. Duration handling:
   - Handle different video durations
   - Find best temporal offset for overlay
   - Trim to overlapping segments when --trim enabled

Relevant files:
- src/vidkompy/core/video_processor.py
- src/vidkompy/core/alignment_engine.py

$END$