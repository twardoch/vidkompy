---
description: Specifications for frame matching and temporal alignment algorithms in video overlay processing
globs: src/vidkompy/*matching*.py,src/vidkompy/framemap.py,src/vidkompy/temporal.py
alwaysApply: false
---


# frame-matching-models

## Frame Matching Core Components

The system implements intelligent frame mapping between foreground and background videos through multiple alignment methods:

### Temporal Alignment Models
importance: 95

Three primary temporal alignment strategies:

1. Audio-based matching
- Uses cross-correlation of audio tracks to determine optimal temporal offset
- Primary method when both videos contain sound

2. Duration-based matching
- Centers foreground content within background duration
- Fallback method when audio matching is unavailable

3. Frame content matching
- Analyzes frame content to create dynamic mapping
- Uses up to 2000 keyframes (configurable via max_keyframes parameter)
- Handles videos with different frame rates by targeting higher FPS

### Frame Selection Logic
importance: 85

The system determines optimal start/end frame pairs through:

- Perfect frame pair identification for START frame
- Perfect frame pair identification for END frame
- Intelligent frame dropping at start/end when needed
- Dynamic trimming to match overlapping segments

### Similarity Models
importance: 80

Two spatial alignment methods for frame matching:

1. Template Matching (precise)
- Default method
- Uses OpenCV template matching
- Identifies exact sub-regions

2. Feature Matching (fast)
- Uses ORB feature detection
- More flexible for modified content
- Handles stretched/modified frame content

### Frame Rate Handling
importance: 75

- Automatically selects higher FPS between sources for output
- Compensates for temporal drift between sources
- Manages frame interpolation when FPS differs
- Handles frame dropping/duplication scenarios

$END$