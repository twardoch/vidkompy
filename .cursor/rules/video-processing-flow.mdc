---
description: Technical flow documentation for video overlay and alignment processing pipeline
globs: src/vidkompy/vidkompy_old.py,src/vidkompy/core/*.py
alwaysApply: false
---


# video-processing-flow

## Video Pipeline Stages [Importance: 95]

1. Video Ingestion
- Loads background and foreground video files via FFmpeg
- Extracts audio tracks if present for potential temporal alignment
- Normalizes frame rates by using the higher FPS between sources

2. Frame Processing 
- Extracts key frames from both videos for alignment analysis
- Handles FPS differences through dynamic frame interpolation
- Maintains temporal consistency during processing

3. Alignment Determination
- Spatial: Locates optimal position of foreground within background
- Temporal: Finds start/end frame pairs for perfect overlay
- Audio-based synchronization when --match_time=audio specified

4. Overlay Composition
- Creates output frames by combining aligned fg/bg content
- Preserves foreground audio track if available
- Trims output to matched segment boundaries

5. Output Generation
- Renders combined frames to output video
- Attaches selected audio track
- Applies specified output parameters (codec, format, etc)

## Key Processing Modes [Importance: 90]

### Temporal Alignment
- Audio: Cross-correlation of audio waveforms
- Duration: Centers foreground within background timeline
- Frames: Dynamic frame-pair matching and mapping

### Spatial Alignment  
- Template: Precise OpenCV-based region matching
- Feature: Fast ORB feature detection and matching
- Center: Direct overlay without alignment

## Data Flow Control [Importance: 85]

- Frame buffer management for processing efficiency
- Dynamic frame selection based on content similarity
- Intelligent trimming of non-overlapping segments
- Audio/video stream synchronization maintenance

$END$