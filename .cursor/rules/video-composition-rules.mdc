---
description: Rules and constraints governing video composition, overlay, and synchronization behavior
globs: src/vidkompy/*.py,tests/*.py
alwaysApply: false
---


# video-composition-rules

## Core Composition Rules [Importance: 95]

1. Foreground Preservation
- Foreground video quality must be preserved as the primary source
- Foreground timing alignment is considered authoritative
- Foreground audio track takes precedence when both sources have audio

2. Video Size Constraints
- Background video dimensions must be >= foreground video
- Foreground is never scaled/resized during composition
- Tool automatically finds optimal spatial offset for overlay

3. Frame Rate Handling
- Output uses highest FPS between foreground and background
- Frame interpolation applies only to lower FPS source
- Frame timing must maintain synchronization between sources

4. Duration Management
- Tool identifies optimal start/end frame pairs for overlay
- Content outside optimal frame pairs is trimmed
- Handles duration mismatches by finding best temporal alignment

## Audio Rules [Importance: 85]

1. Track Selection
- Use foreground audio if both sources have sound
- Fall back to background audio if foreground is silent
- Audio can guide temporal alignment via cross-correlation

2. Synchronization
- Audio alignment takes precedence over frame alignment when specified
- Temporal offset determined by audio matching carries to video tracks
- Audio tracks must maintain phase alignment during composition

## Quality Thresholds [Importance: 80]

1. Content Matching
- Background content may be compressed/modified version of foreground
- Tool must handle non-identical but similar frame contents
- Frame matching uses dynamic thresholds for alignment

2. Frame Selection
- Maximum 2000 keyframes used for temporal alignment
- Frame pairs selected based on content similarity metrics
- Edge frames may be dropped to optimize alignment quality

$END$