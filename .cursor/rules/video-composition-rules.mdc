---
description: Rules and constraints for video composition, synchronization, and quality control in vidkompy
globs: src/vidkompy/core/alignment_engine.py,src/vidkompy/core/dtw_aligner.py,src/vidkompy/core/video_processor.py
alwaysApply: false
---


# video-composition-rules

## Core Composition Rules

### Video Quality Preservation
- Foreground video frames must never be modified or dropped
- Background video can be warped/adapted to match foreground
- Output resolution matches foreground when possible
- Foreground timing dictates final frame sequencing
- Background content stretched/compressed to maintain sync

### Audio Integration 
- Foreground audio track takes precedence if available
- Background audio used only when foreground lacks audio
- Audio synchronization must match video frame alignment
- No audio resampling/quality reduction allowed

### Frame Synchronization
- Every foreground frame requires matching background frame
- Frame matching based on perceptual similarity scoring
- Temporal monotonicity must be preserved
- Background frames interpolated for gaps
- Border regions given special consideration in matching

### Quality Thresholds
- Minimum similarity score: 0.75 for frame matches
- Maximum temporal offset: 0.5 seconds
- Required spatial alignment confidence: 0.85
- Minimum keyframe density: 200 frames
- Maximum frame interpolation gap: 5 frames

### Border Mode Rules
- Edge region detection required
- Border thickness configurable (default 8px)
- Smooth blending at transitions
- Special perceptual hashing for borders
- Edge alignment takes priority over content

### Processing Constraints
- Sequential frame access required
- No random frame access allowed
- Foreground frame order preserved
- Background frame order flexible
- Single-pass composition only

$END$