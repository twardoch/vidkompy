---
description: Technical specification for frame matching algorithms and temporal alignment models in video processing
globs: src/vidkompy/core/frame_fingerprint.py,src/vidkompy/core/dtw_aligner.py,src/vidkompy/core/alignment_engine.py
alwaysApply: false
---


# frame-matching-models

## Frame Fingerprinting System (Importance: 95)
- Multi-algorithm perceptual hash fusion combining:
  - pHash for frequency domain analysis 
  - AverageHash for luminance patterns
  - ColorMomentHash for color distribution
  - MarrHildrethHash for edge structure detection
- Weighted fingerprint scoring based on content type reliability
- Border region prioritization for letterboxed content matching

## Temporal Alignment Models (Importance: 98)
- Dynamic Time Warping (DTW) with Sakoe-Chiba band constraint
- Foreground-first frame preservation principle
- Bidirectional alignment with confidence-weighted path merging
- Keyframe anchoring for drift prevention
- Polynomial drift correction with adaptive window sizes

## Frame Mapping Engines (Importance: 92)
- Fast Engine:
  - Direct 1:1 frame correspondence
  - Forced monotonic progression
  - Early stopping on perfect matches
- Precise Engine:
  - Multi-resolution temporal pyramid
  - Progressive refinement through resolution levels
  - Local neighborhood search within alignment bands
- Masked Engine:
  - Content-aware region detection
  - Border-based alignment for letterboxed videos
  - Selective feature matching on visible regions

## Synchronization Orchestration (Importance: 88)
- Frame selection policies:
  1. Preserve all foreground frames
  2. Adapt background timing to match
  3. Apply drift correction at keyframes
- Audio alignment rules:
  - Foreground audio priority
  - Background audio fallback
  - Timing synchronization with composed video

Key Implementation Files:
- /src/vidkompy/core/frame_fingerprint.py
- /src/vidkompy/core/dtw_aligner.py
- /src/vidkompy/core/alignment_engine.py

$END$