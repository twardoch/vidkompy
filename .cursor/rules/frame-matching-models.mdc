---
description: Frame matching models and algorithms for video synchronization and overlay alignment
globs: src/vidkompy/core/frame_fingerprint.py,src/vidkompy/core/dtw_aligner.py,src/vidkompy/core/spatial_alignment.py
alwaysApply: false
---


# frame-matching-models

## Frame Fingerprinting Models

Implements multi-algorithm perceptual hashing to create unique frame signatures:

1. Core Hash Combination
- pHash: DCT-based frequency domain analysis
- AverageHash: Mean pixel intensity patterns 
- ColorMomentHash: Statistical color distribution
- MarrHildrethHash: Edge and contour detection

2. Frame Similarity Model
- Weighted combination of hash distances
- Color histogram correlation scoring
- Border region masking for edge-based matching

## Temporal Alignment Model 

DTW-based frame mapping system with constraints:

1. Frame Sequence Mapping
- Monotonic path finding through similarity matrix
- Sakoe-Chiba band limiting maximum temporal offset
- Keyframe interpolation for continuous mapping

2. Matching Modes
- Full frame comparison for precise alignment
- Border region analysis for edge-based sync
- Classic keyframe matching fallback

## Spatial Positioning Model

Template matching system for overlay positioning:

1. Position Detection
- Normalized cross-correlation scoring
- Mid-point frame sampling strategy
- Scale factor computation for size mismatches

2. Alignment Confidence
- Match quality scoring
- Position validation checks
- Fallback positioning rules

## Integration Rules

1. Frame Selection Logic
- Foreground frame preservation priority
- Background frame warping/adaptation
- Keyframe density calculation

2. Quality Control
- Alignment confidence thresholds
- Match validation rules
- Fallback behavior triggers

3. Mode Selection
- Border vs full-frame analysis
- Temporal sync method determination
- Spatial alignment strategy choice

Importance Scores:
- Frame Fingerprinting Models: 95 (Core matching capability)
- Temporal Alignment Model: 90 (Critical sync logic)
- Spatial Positioning Model: 85 (Key overlay functionality)
- Integration Rules: 75 (Important workflow control)

$END$